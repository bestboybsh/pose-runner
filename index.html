<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pose Runner (Stable)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    button, select { font-size: 16px; padding: 10px 12px; }
    #wrap { display: grid; gap: 12px; grid-template-columns: 1fr; max-width: 1400px; }
    .game-area { position: relative; display: inline-block; }
    .video-container {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 200px;
      height: auto;
      border-radius: 8px;
      border: 2px solid #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 10;
      display: none;
      overflow: hidden;
      background: #111;
    }
    #video { 
      width: 100%;
      height: auto;
      display: block;
      transform: scaleX(-1); /* ì¢Œìš° ëŒ€ì¹­ (ë¯¸ëŸ¬ë§) */
    }
    #skeletonCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 11;
    }
    #game { 
      width: min(92vw, 980px); 
      height: auto; 
      border-radius: 12px; 
      background: #111; 
      display: block;
    }
    #hud { white-space: pre-wrap; background: #f6f6f6; padding: 12px; border-radius: 12px; max-height: 200px; overflow-y: auto; }
    .pill { display: inline-block; padding: 4px 10px; border-radius: 999px; background: #eee; margin-right: 6px; }
    .muted { color: #666; }
    #leaderboard { background: #f6f6f6; padding: 12px; border-radius: 12px; margin-top: 12px; display: none; }
    #leaderboard h3 { margin-top: 0; }
    
    /* í…ŒìŠ¤íŠ¸ íŒ¨ë„ì„ í™”ë©´ì— í•­ìƒ í‘œì‹œë˜ë„ë¡ */
    .content-grid {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 12px;
      align-items: start;
    }
    
    /* ì–¼êµ´ ë¯¸ë¦¬ë³´ê¸° (ë””ë²„ê¹…ìš©) */
    #facePreview {
      position: fixed;
      top: 12px;
      right: 12px;
      width: 200px;
      height: 250px;
      background: #222;
      border: 2px solid #444;
      border-radius: 8px;
      padding: 8px;
      display: none;
      z-index: 1000;
    }
    #facePreview img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 4px;
    }
    #facePreview::before {
      content: "Captured Face (Debug)";
      display: block;
      color: #fff;
      font-size: 12px;
      margin-bottom: 4px;
      text-align: center;
    }
    #poseTest { 
      background: #f6f6f6; 
      padding: 12px; 
      border-radius: 12px; 
      display: none;
      max-height: 600px;
      overflow-y: auto;
      position: sticky;
      top: 12px;
    }
    #poseTest h3 { margin-top: 0; margin-bottom: 12px; font-size: 16px; }
    
    @media (max-width: 1400px) {
      .content-grid {
        grid-template-columns: 1fr;
      }
      #poseTest {
        position: relative;
        top: 0;
        max-height: 400px;
      }
    }
    
  </style>
</head>
<body>

  <h2>Pose Runner (Stable)</h2>

  <div id="wrap">
    <div class="row">
      <button id="btnTakePhoto" disabled>ğŸ“¸ Take Photo</button>
      <button id="btnCal" disabled>Calibrate</button>
      <button id="btnStop" disabled>Stop</button>
      <button id="btnTest">í…ŒìŠ¤íŠ¸ íŒ¨ë„ (T)</button>
      <button id="btnMusic" title="Toggle Music">ğŸ”Š Music</button>

      <label class="pill">
        Facing
        <select id="facing">
          <option value="user">Front</option>
          <option value="environment">Back</option>
        </select>
      </label>

      <span class="pill">Status: <b id="status">INIT</b></span>
      <span class="pill">Time: <b id="score">0</b>s</span>
      <span class="pill">â¤ï¸ Lives: <b id="lives">3</b></span>
      <span class="pill">ğŸ’– Hearts: <b id="items">0</b></span>
      <span class="pill">FPS: <b id="fps">0</b></span>
    </div>

    <div class="muted">
      Controls: Jump = real jump or Space. Duck = squat or ArrowDown (hold). Restart = R. Test Panel = T.
      Flow: Start camera â†’ Load pose â†’ stand still 1s â†’ Calibrate.
    </div>

    <div class="content-grid">
      <div>
        <div class="game-area">
          <div class="video-container">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="skeletonCanvas"></canvas>
          </div>
          <canvas id="game" width="980" height="420"></canvas>
        </div>
        <div id="hud"></div>
        <div id="leaderboard"></div>
      </div>
      <div id="poseTest"></div>
    </div>
  </div>
  
  <!-- ì–¼êµ´ ë¯¸ë¦¬ë³´ê¸° (ë””ë²„ê¹…ìš©) -->
  <div id="facePreview">
    <img id="facePreviewImg" alt="Captured face">
  </div>
  
  <!-- ë°°ê²½ ìŒì•… -->
  <audio id="bgMusic" preload="auto" loop>
    <!-- ìŒì•… íŒŒì¼: src/assets í´ë”ì— ìˆìŒ -->
    <source src="src/assets/music.mp3" type="audio/mpeg">
  </audio>
  
  <!-- ê²Œì„ ì˜¤ë²„ íš¨ê³¼ìŒ -->
  <audio id="gameOverSound" preload="auto">
    <!-- ê²Œì„ ì˜¤ë²„ íš¨ê³¼ìŒ íŒŒì¼: src/assets í´ë”ì— ìˆìŒ -->
    <source src="src/assets/gameover.mp3" type="audio/mpeg">
  </audio>

  <script type="module">
    try {
      console.log('[index.html] Script starting...');
      
      import('./src/app/main.js').then(module => {
        console.log('[index.html] Module loaded:', module);
        const { App } = module;
        
        console.log('[index.html] Creating App instance...');
        const app = new App({
          video: document.getElementById("video"),
          canvas: document.getElementById("game"),
          skeletonCanvas: document.getElementById("skeletonCanvas"),
          musicEl: document.getElementById("bgMusic"),
          gameOverSoundEl: document.getElementById("gameOverSound"),
          buttons: {
            start: null,  // ìë™ ì‹œì‘ìœ¼ë¡œ ì¸í•´ ë²„íŠ¼ ì œê±°
            loadPose: null,  // ìë™ ì‹œì‘ìœ¼ë¡œ ì¸í•´ ë²„íŠ¼ ì œê±°
            takePhoto: document.getElementById("btnTakePhoto"),
            calibrate: document.getElementById("btnCal"),
            stop: document.getElementById("btnStop"),
            test: document.getElementById("btnTest"),
            music: document.getElementById("btnMusic")
          },
          statusEl: document.getElementById("status"),
          scoreEl: document.getElementById("score"),
          fpsEl: document.getElementById("fps"),
          hudEl: document.getElementById("hud"),
          livesEl: document.getElementById("lives"),
          facingSel: document.getElementById("facing"),
          leaderboardEl: document.getElementById("leaderboard"),
          poseTestEl: document.getElementById("poseTest")
        });

        console.log('[index.html] App instance created:', app);
        
        // ì¦‰ì‹œ ì´ˆê¸°í™” ì‹œë„ (DOMContentLoaded ë˜ëŠ” load ì´ë²¤íŠ¸ ëŒ€ê¸°)
        function initApp() {
          console.log('[index.html] Initializing app...');
          app.initialize();
          
          // ìë™ìœ¼ë¡œ ì¹´ë©”ë¼ ì‹œì‘
          console.log('[index.html] Auto-starting camera...');
          setTimeout(() => {
            app.startCamera();
          }, 100); // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ ì´ˆê¸°í™”ê°€ ì™„ë£Œë˜ë„ë¡
          
          // Start cameraì™€ Load poseëŠ” ìë™ìœ¼ë¡œ ì‹¤í–‰ë¨ (ë²„íŠ¼ ì œê±°)
        }
        
        // DOMì´ ì¤€ë¹„ë˜ì—ˆëŠ”ì§€ í™•ì¸
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initApp);
        } else {
          // ì´ë¯¸ ë¡œë“œë¨
          initApp();
        }
        
        // window load ì´ë²¤íŠ¸ë„ ëŒ€ê¸°
        window.addEventListener("load", () => {
          console.log('[index.html] Window loaded');
          initApp();
        });
        
        // ì „ì—­ìœ¼ë¡œ app ë…¸ì¶œ (ë””ë²„ê¹…ìš©)
        window.app = app;
        console.log('[index.html] App exposed as window.app');
      }).catch(error => {
        console.error('[index.html] ERROR loading module:', error);
        const hudEl = document.getElementById("hud");
        if (hudEl) {
          hudEl.innerHTML = `<div style="color: red;">ERROR: Failed to load app module. Check console for details.<br>${error.message}</div>`;
        }
      });
    } catch (error) {
      console.error('[index.html] ERROR in script:', error);
      const hudEl = document.getElementById("hud");
      if (hudEl) {
        hudEl.innerHTML = `<div style="color: red;">ERROR: Script error. Check console for details.<br>${error.message}</div>`;
      }
    }
  </script>
</body>
</html>
