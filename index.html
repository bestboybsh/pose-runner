<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pose Runner (Stable)</title>
  <style>
    body { 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    h2 {
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      margin-top: 0;
    }
    .row { 
      display: flex; 
      gap: 10px; 
      flex-wrap: wrap; 
      align-items: center;
      background: rgba(255, 255, 255, 0.95);
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    button, select { 
      font-size: 16px; 
      padding: 10px 12px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #ccc;
    }
    select {
      background: white;
      color: #333;
      border: 2px solid #ddd;
    }
    #wrap { 
      display: grid; 
      gap: 12px; 
      grid-template-columns: 1fr; 
      max-width: 1400px;
      margin: 0 auto;
    }
    .game-area { position: relative; display: inline-block; }
    .video-container {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 200px;
      height: auto;
      border-radius: 8px;
      border: 2px solid #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 10;
      display: none;
      overflow: hidden;
      background: #111;
    }
    #video { 
      width: 100%;
      height: auto;
      display: block;
      transform: scaleX(-1); /* Ï¢åÏö∞ ÎåÄÏπ≠ (ÎØ∏Îü¨ÎßÅ) */
    }
    #skeletonCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 11;
    }
    #game { 
      width: min(92vw, 980px); 
      height: auto; 
      border-radius: 16px; 
      background: #111; 
      display: block;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      border: 3px solid rgba(255,255,255,0.1);
    }
    #hud { 
      white-space: pre-wrap; 
      background: rgba(255, 255, 255, 0.95); 
      padding: 16px; 
      border-radius: 12px; 
      max-height: 200px; 
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }
    .pill { 
      display: inline-block; 
      padding: 6px 14px; 
      border-radius: 999px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin-right: 8px;
      font-weight: 500;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .pill b {
      font-weight: 700;
    }
    .muted { 
      color: rgba(255,255,255,0.9);
      background: rgba(255, 255, 255, 0.1);
      padding: 10px;
      border-radius: 8px;
      backdrop-filter: blur(10px);
    }
    #leaderboard { 
      background: rgba(255, 255, 255, 0.95); 
      padding: 16px; 
      border-radius: 12px; 
      margin-top: 12px; 
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    #leaderboard h3 { 
      margin-top: 0;
      color: #667eea;
    }
    
    /* ÌÖåÏä§Ìä∏ Ìå®ÎÑêÏùÑ ÌôîÎ©¥Ïóê Ìï≠ÏÉÅ ÌëúÏãúÎêòÎèÑÎ°ù */
    .content-grid {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 12px;
      align-items: start;
    }
    
    /* ÏñºÍµ¥ ÎØ∏Î¶¨Î≥¥Í∏∞ (ÎîîÎ≤ÑÍπÖÏö©) */
    #facePreview {
      position: fixed;
      top: 12px;
      right: 12px;
      width: 200px;
      height: 250px;
      background: #222;
      border: 2px solid #444;
      border-radius: 8px;
      padding: 8px;
      display: none;
      z-index: 1000;
    }
    #facePreview img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 4px;
    }
    #facePreview::before {
      content: "Captured Face (Debug)";
      display: block;
      color: #fff;
      font-size: 12px;
      margin-bottom: 4px;
      text-align: center;
    }
    #poseTest { 
      background: #f6f6f6; 
      padding: 12px; 
      border-radius: 12px; 
      display: none;
      max-height: 600px;
      overflow-y: auto;
      position: sticky;
      top: 12px;
    }
    #poseTest h3 { margin-top: 0; margin-bottom: 12px; font-size: 16px; }
    
    @media (max-width: 1400px) {
      .content-grid {
        grid-template-columns: 1fr;
      }
      #poseTest {
        position: relative;
        top: 0;
        max-height: 400px;
      }
    }
    
  </style>
</head>
<body>

  <h2>Pose Runner (Stable)</h2>

  <div id="wrap">
    <div class="row">
      <button id="btnTakePhoto" disabled>üì∏ Take Photo</button>
      <button id="btnTest">ÌÖåÏä§Ìä∏ Ìå®ÎÑê (T)</button>
      <button id="btnMusic" title="Toggle Music">üîä Music</button>

      <label class="pill">
        Facing
        <select id="facing">
          <option value="user">Front</option>
          <option value="environment">Back</option>
        </select>
      </label>

      <span class="pill">Status: <b id="status">INIT</b></span>
      <span class="pill">‚ù§Ô∏è Lives: <b id="lives">3</b></span>
      <span class="pill">FPS: <b id="fps">0</b></span>
    </div>

    <div class="muted">
      Controls: Jump = real jump or Space. Duck = squat or ArrowDown (hold). Restart = R. Test Panel = T.
      Flow: Start camera ‚Üí Load pose ‚Üí stand still 1s ‚Üí Calibrate.
    </div>

    <div class="content-grid">
      <div>
        <div class="game-area">
          <div class="video-container">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="skeletonCanvas"></canvas>
          </div>
          <canvas id="game" width="980" height="420"></canvas>
        </div>
        <div id="hud"></div>
        <div id="leaderboard"></div>
      </div>
      <div id="poseTest"></div>
    </div>
  </div>
  
  <!-- ÏñºÍµ¥ ÎØ∏Î¶¨Î≥¥Í∏∞ (ÎîîÎ≤ÑÍπÖÏö©) -->
  <div id="facePreview">
    <img id="facePreviewImg" alt="Captured face">
  </div>
  
  <!-- Î∞∞Í≤Ω ÏùåÏïÖ -->
  <audio id="bgMusic" preload="auto" loop>
    <!-- ÏùåÏïÖ ÌååÏùº: src/assets Ìè¥ÎçîÏóê ÏûàÏùå -->
    <source src="src/assets/music.mp3" type="audio/mpeg">
  </audio>
  
  <!-- Í≤åÏûÑ Ïò§Î≤Ñ Ìö®Í≥ºÏùå -->
  <audio id="gameOverSound" preload="auto">
    <!-- Í≤åÏûÑ Ïò§Î≤Ñ Ìö®Í≥ºÏùå ÌååÏùº: src/assets Ìè¥ÎçîÏóê ÏûàÏùå -->
    <source src="src/assets/gameover.mp3" type="audio/mpeg">
  </audio>

  <script type="module">
    try {
      console.log('[index.html] Script starting...');
      
      import('./src/app/main.js').then(module => {
        console.log('[index.html] Module loaded:', module);
        const { App } = module;
        
        console.log('[index.html] Creating App instance...');
        const app = new App({
          video: document.getElementById("video"),
          canvas: document.getElementById("game"),
          skeletonCanvas: document.getElementById("skeletonCanvas"),
          musicEl: document.getElementById("bgMusic"),
          gameOverSoundEl: document.getElementById("gameOverSound"),
          buttons: {
            start: null,  // ÏûêÎèô ÏãúÏûëÏúºÎ°ú Ïù∏Ìï¥ Î≤ÑÌäº Ï†úÍ±∞
            loadPose: null,  // ÏûêÎèô ÏãúÏûëÏúºÎ°ú Ïù∏Ìï¥ Î≤ÑÌäº Ï†úÍ±∞
            takePhoto: document.getElementById("btnTakePhoto"),
            calibrate: null,  // Calibrate Î≤ÑÌäº Ï†úÍ±∞
            stop: null,  // Stop Î≤ÑÌäº Ï†úÍ±∞
            test: document.getElementById("btnTest"),
            music: document.getElementById("btnMusic")
          },
          statusEl: document.getElementById("status"),
          scoreEl: document.getElementById("score"),
          fpsEl: document.getElementById("fps"),
          hudEl: document.getElementById("hud"),
          livesEl: document.getElementById("lives"),
          facingSel: document.getElementById("facing"),
          leaderboardEl: document.getElementById("leaderboard"),
          poseTestEl: document.getElementById("poseTest")
        });

        console.log('[index.html] App instance created:', app);
        
        // Ï¶âÏãú Ï¥àÍ∏∞Ìôî ÏãúÎèÑ (DOMContentLoaded ÎòêÎäî load Ïù¥Î≤§Ìä∏ ÎåÄÍ∏∞)
        function initApp() {
          console.log('[index.html] Initializing app...');
          app.initialize();
          
          // ÏûêÎèôÏúºÎ°ú Ïπ¥Î©îÎùº ÏãúÏûë
          console.log('[index.html] Auto-starting camera...');
          setTimeout(() => {
            app.startCamera();
          }, 100); // ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ÏùÑ ÎëêÏñ¥ Ï¥àÍ∏∞ÌôîÍ∞Ä ÏôÑÎ£åÎêòÎèÑÎ°ù
          
          // Start cameraÏôÄ Load poseÎäî ÏûêÎèôÏúºÎ°ú Ïã§ÌñâÎê® (Î≤ÑÌäº Ï†úÍ±∞)
        }
        
        // DOMÏù¥ Ï§ÄÎπÑÎêòÏóàÎäîÏßÄ ÌôïÏù∏
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initApp);
        } else {
          // Ïù¥ÎØ∏ Î°úÎìúÎê®
          initApp();
        }
        
        // window load Ïù¥Î≤§Ìä∏ÎèÑ ÎåÄÍ∏∞
        window.addEventListener("load", () => {
          console.log('[index.html] Window loaded');
          initApp();
        });
        
        // Ï†ÑÏó≠ÏúºÎ°ú app ÎÖ∏Ï∂ú (ÎîîÎ≤ÑÍπÖÏö©)
        window.app = app;
        console.log('[index.html] App exposed as window.app');
      }).catch(error => {
        console.error('[index.html] ERROR loading module:', error);
        const hudEl = document.getElementById("hud");
        if (hudEl) {
          hudEl.innerHTML = `<div style="color: red;">ERROR: Failed to load app module. Check console for details.<br>${error.message}</div>`;
        }
      });
    } catch (error) {
      console.error('[index.html] ERROR in script:', error);
      const hudEl = document.getElementById("hud");
      if (hudEl) {
        hudEl.innerHTML = `<div style="color: red;">ERROR: Script error. Check console for details.<br>${error.message}</div>`;
      }
    }
  </script>
</body>
</html>
